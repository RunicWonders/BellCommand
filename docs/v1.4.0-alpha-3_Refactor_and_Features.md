# BellCommand v1.4.0-alpha-3 开发与功能文档

本文档详细说明了 BellCommand 在 v1.4.0-alpha-3 版本中的重大重构、新功能及其配置方式。

---

## 1. 配置管理系统重构 (Configuration System Refactoring)

为了提高插件的可维护性和扩展性，我们彻底重构了配置管理系统。

### 1.1 多文件夹架构设计
- **主配置文件 (`config.yml`)**: 仅保留全局系统参数（如调试模式、检查更新、语言设置等）。
- **模块化物品配置**: 
  - 默认采用 `Default_config/` 文件夹存储物品定义。
  - 支持自定义文件夹，文件夹内必须包含 `commands.yml`。
  - 插件会自动扫描并合并所有符合规则的配置文件。

### 1.2 线程安全与并发控制
- 引入了 `java.util.concurrent.locks.ReentrantReadWriteLock`。
- **读锁**: 在玩家触发命令、读取配置时使用，支持多线程并发读取。
- **写锁**: 在执行 `/bc reload` 或文件热重载时使用，确保重载期间配置的一致性，防止脏读。

### 1.3 实时热重载机制
- 利用 `java.nio.file.WatchService` 监控配置文件。
- 玩家直接修改磁盘上的 `.yml` 文件并保存后，插件会立即感知并自动执行热重载逻辑，无需手动输入命令。

### 1.4 平滑迁移策略
- **检测旧配置**: 自动识别 1.3.x 及以前版本的 `config.yml` 结构。
- **自动备份**: 迁移前自动创建 `config.backup.yml`。
- **配置分发**: 将原全局 `auto-give` 和 `auto-cleanup` 设置自动分发到每个迁移后的物品项中，确保用户原有功能不受影响。
- **存储位置**: 迁移后的旧物品配置将存储在 `Legacy_config/commands.yml` 中。

---

## 2. 次数性物品系统 (Consumable Item System)

新增“次数性物品”功能，允许开发者精细控制物品的使用寿命。

### 2.1 消耗模式 (Modes)

| 模式 | 描述 | 关键配置项 |
| :--- | :--- | :--- |
| `COUNT` | 固定数量消耗 | `amount` |
| `PROBABILITY` | 概率消耗固定数量 | `probability`, `amount` |
| `RANGE` | 区间随机数量消耗 | `min-amount`, `max-amount` |
| `PROBABILITY_RANGE` | 概率触发后的区间随机消耗 | `probability`, `min-amount`, `max-amount` |

### 2.2 配置示例

```yaml
items:
  super_food:
    item-id: COOKED_BEEF
    name: "&6超级牛肉"
    consumable:
      enabled: true
      mode: "PROBABILITY_RANGE"
      probability: 0.5    # 50% 概率触发消耗
      min-amount: 1      # 最少消耗 1 个
      max-amount: 3      # 最多消耗 3 个
    commands:
      right-click:
        1:
          command: "heal %player%"
          as-console: true
```

---

## 3. 技术规范与环境 (Technical Specifications)

- **开发环境**: Windows Server 2022 / PowerShell。
- **构建工具**: Maven 3.9.12。
- **Java 版本**: JDK 21。
- **编码规范**: 全面支持 UTF-8 编码，解决多语言环境下的乱码问题。
- **国际化**: 所有系统日志（迁移成功、热重载提示等）均已集成到 `LanguageManager`。

---

## 4. 知识库总结 (Knowledge Base)

1. **资源释放**: 使用 `saveResource("Default_config/commands.yml", false)` 确保插件首次运行时自动创建示例模板。
2. **消耗逻辑**: 消耗判定在命令执行后立即执行。若 `ItemStack.getAmount()` 减去消耗量小于等于 0，则该物品堆栈将被销毁。
3. **性能监控**: 集成了 `PerformanceMonitor`，对配置加载和热重载过程进行毫秒级耗时监控。
